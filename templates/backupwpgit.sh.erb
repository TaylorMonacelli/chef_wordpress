#!/usr/bin/env bash

# Auto-generated by Chef.
# Local modifications will be overwritten.


export GIT_DIR="${GIT_DIR:-<%= @config_backup_repo_path %>}"
export GIT_WORK_TREE="${GIT_WORK_TREE:-/}"

status=0

cd "$GIT_WORK_TREE"

# check for uncommitted files
if [ ! -z "$(git status --porcelain)" ]; then
	# we'll exit with nonzero so cron sends email
	git ls-files -o --exclude-standard -z | xargs -r -0 git add
	git -c user.name="$USER" -c user.email="$USER@$(hostname)" commit -m "Snapshot: new files added"
	status=1
fi

# check for changed files and commit them
if ! git diff --no-ext-diff --quiet --exit-code ; then
    git -c user.name="$USER" -c user.email="$USER@$(hostname)" commit -am "Snapshot: files changed or removed"
fi

exit $status
