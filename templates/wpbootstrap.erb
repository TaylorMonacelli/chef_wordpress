#!/usr/bin/env bash

# Auto-generated by Chef.
# Local modifications will be overwritten.

set -x

/usr/local/bin/aws s3 sync --quiet s3://backup-www.streambox.com/var/www /tmp/www
mkdir -p <%= node['chef_wordpress']['wordpress_root'] %>

[ ! -z "$(find /tmp -name www -type d -mmin -120)" ] && # rsync is slow
  time rsync \
    --max-size=200m \
    --recursive \
    --delete \
    --delete-excluded \
    --exclude wp-content/themes/ \
    --exclude wp-content/plugins/ \
    --exclude wp-content/w3tc-config/ \
    --exclude wp-content/wfcache/ \
    --exclude google43e41bc553d2e49c.html \
    --exclude google8d48204cb1a58057.html \
    --exclude readme.bf4d3368595aaba0b44e84f3aad25a83.html \
    --exclude wp-content/debug.log \
    --exclude wp-content/.htaccess \
    --exclude wp-content/db.php \
    --exclude wp-content/wp-link-status-salt.php \
    --exclude wp-content/htaccess.backup \
    --exclude wp-content/advanced-cache.php \
    --exclude .htaccess \
    /tmp/www/html/wordpress/ <%= node['chef_wordpress']['wordpress_root'] %>

# help prevent wp core update-db from updating production by ensuring
# our database connection string is coming from chef converge
rm -f <%= node['chef_wordpress']['wordpress_root'] %>/wp-config.php

/usr/local/bin/aws s3 cp --quiet s3://backup-www.streambox.com/wordpress.sql /tmp
/usr/local/bin/aws s3 cp --quiet s3://backup-www.streambox.com/wordpress.wxr /tmp

chef-client --override-runlist chef_wordpress::nginx,chef_wordpress::wpupgrade
mysql -Dtrash </tmp/debug_db_create.sql
mysql -Dtrash </tmp/wordpress.sql
/usr/local/bin/wp1 option update siteurl https://<%= node['fqdn'] %>
/usr/local/bin/wp1 core update
/usr/local/bin/wp1 plugin install --force --activate wordpress-importer
/usr/local/bin/wp1 import --quiet --authors=create /tmp/wordpress.wxr >/tmp/wordpress.wxr.log
/opt/chef/embedded/bin/chef-client --no-color
/usr/local/bin/wp1 option update siteurl https://<%= node['fqdn'] %>
/usr/local/bin/wp1 search-replace 'www.streambox.com' <%= node['fqdn'] %>
/usr/local/bin/wp1 search-replace '<%= node['fqdn'] %>/wordpress' '<%= node['fqdn'] %>'
/usr/local/bin/wp1 search-replace 'http://<%= node['fqdn'] %>' 'https://<%= node['fqdn'] %>'
/usr/local/bin/wp1 core update-db

cat << __eot__ >/tmp/bootstrap_email.txt
From: <Bootstrap from $(hostname)> root
Subject: Bootstrapping $(hostname) is done
__eot__
sendmail root </tmp/bootstrap_email.txt
